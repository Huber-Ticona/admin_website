{% extends 'layout.html' %}

{% block encabezado %}
    <title>Categoria Agregar</title>
    <link rel="stylesheet" href="{{url_for('static', filename= 'css/agregar_categoria.css')}}">

{% endblock %}

{% block contenido %}

<div class="contenedor-mensajes">
    
</div>



<div class="row m-3">
    <div class="col">
       
        <div class="input-group mb-3">
            <div class="input-group-prepend">
                <span class="input-group-text" >Categoria padre</span>
            </div>
            <select class="custom-select" id="cat_padre">
            {% if categorias %}
            <option value="0" id="0" selected >Sin padre</option>

            {% for item in categorias %}
                <!--(id, nombre_categoria, nombre_padre, padre_id, nivel_Categoria) -->
                {% if categoria != None %}
                    {% if item[0] == categoria.padre_id %}
                        {# Cuando se modifica #}
                        {% if item[2] != None %}
                        <option value="{{item[0]}}" id="{{item[4]}}" selected>{{item[2]}}>{{item[1]}}</span></option>
                        {% else %}
                        <option value="{{item[0]}}" id="{{item[4]}}" selected>(Raiz) > {{item[1]}}</span></option>
                        {% endif %}

                    {% else %}
                    <option value="{{item[0]}}" id="{{item[4]}}">{{item[2]}}>{{item[1]}}</span></option>
                    {%endif%}

                {% else %}
                    {% if item[2] != None %}
                    <option value="{{item[0]}}" id="{{item[4]}}">{{item[2]}}>{{item[1]}}</span></option>
                    {% else %}
                    <option value="{{item[0]}}" id="{{item[4]}}">(Raiz) > {{item[1]}}</span></option>
                    {% endif %}
                {% endif %}


                {

            {% endfor %}
            {% else %}
            <option value="0" id="0" selected >Sin padre</option>
            {% endif %}
            </select>
        </div>
        
        <div class="input-group mb-3">
            <div class="input-group-prepend">
                <span class="input-group-text" >Nombre categoria</span>
            </div>
            {% if categoria %}
            <input type="text" class="form-control"  id="cat_nombre" placeholder="Ej: cat" value="{{categoria.nombre}}">
            {% else %}
            <input type="text" class="form-control"  id="cat_nombre" placeholder="Ej: cat" >
            {%endif%}
        </div>
        <div class="input-group mb-3">
            <div class="input-group-prepend">
                <span class="input-group-text" >Nivel calculado</span>
            </div>
            <input type="number" class="form-control"  id="cat_nivel" placeholder="0" disabled>
        </div>

        {% if categoria != None %}
            <button class="btn btn-secondary" onclick="actualizar()">Actualizar</button>
            <script>
                var id = '{{categoria.categoria_id}}'  // 1:modificar  0:registrar

            </script>
        {%else%}
            <button class="btn btn-secondary" onclick="regcat()">Registrar</button>
            <script>
                var accion = 0 // 1:modificar  0:registrar
                var id = null
            </script>
        {%endif%}
        
    </div>
    
    
</div>
    
            
            <script>

                $('#cat_padre').change(function(e){
                    let nivel_x = parseInt($(this).children(':selected').attr('id'))
                    let padre_x = parseInt($('#cat_padre').val())
                    if(padre_x != 0){
                        nivel_x = nivel_x + 1
                    }
                    $('#cat_nivel').val(nivel_x)
                    console.log(nivel_x)
                })

                function regcat(){
                    console.log('--- registrando -----')
    
                    let nivel =  parseInt($('#cat_padre').children(':selected').attr('id'))
                    let padre = parseInt($('#cat_padre').val())
                    if(padre != 0){
                        nivel = nivel + 1
                    }
                    let nombre = $('#cat_nombre').val()
                    let dict =  {
                        "nombre_categoria": nombre,
                        "nivel":nivel , 
                        "padre_id": padre
                     }
                    console.log(dict)
                    if(nombre != ''){
                        $.ajax({
                            
                            url: "{{url_for('main.agregar_categoria')}}",
                            type: 'post',
                            contentType: "application/json; charset=utf-8",
                            data: JSON.stringify(dict),
                            success: function (resp) {
                                console.log(resp)
                                if (resp.data) {
                                    console.log('ahi respuesta')
                                    msj = '<div class="alert alert-warning"><button type="button" class="close" data-dismiss="alert">&times;</button>' + resp.mensaje + '</div>'
                                    $('.contenedor-mensajes').append(msj)
                                    $('#nombre_categoria').val('')
                                }
                            }
                        }).fail(function() {
                            alert( "error" );
                          })

                    }else{
                        alert('Campo nombre necesario')
                    }
    
                    console.log('--- registrando END-----')
                }

                function actualizar(){
                    console.log('--- actualizando -----')
    
                    let nivel =  parseInt($('#cat_padre').children(':selected').attr('id'))
                    let padre = parseInt($('#cat_padre').val())
                    if(padre != 0){
                        nivel = nivel + 1
                    }
                    let nombre = $('#cat_nombre').val()
                    let dict =  {
                        "nombre_categoria": nombre,
                        "nivel":nivel , 
                        "padre_id": padre
                     }
                    console.log(dict)
                    if(nombre != ''){
                        $.ajax({
                            url: "/categoria/modificar/"+ id,
                            type: 'post',
                            contentType: "application/json; charset=utf-8",
                            data: JSON.stringify(dict),
                            success: function (resp) {
                                console.log(resp)
                                if (resp.data) {
                                    console.log('ahi respuesta')
                                    msj = '<div class="alert alert-warning"><button type="button" class="close" data-dismiss="alert">&times;</button>' + resp.mensaje + '</div>'
                                    $('.contenedor-mensajes').append(msj)
                                    $('#nombre_categoria').val('')
                                }
                            }
                        }).fail(function() {
                            alert( "error" );
                          })

                    }else{
                        alert('Campo nombre necesario')
                    }
    
                    console.log('--- actualizando END-----')
                }
                
            </script>
        


        
{% endblock %}